---
title: "dataanalysis"
author: "Olga Chyzh"
date: "February 14, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE,fig.cap = "...")
```

```{r}
rm(list=ls())
trumpilot<-read.csv("soydata.csv", header=TRUE)
## Generate measure of vote shift
trumpilot$votech <- with(trumpilot, log(Rep18*Dem16/(Rep16*Dem18)))
trumpilot<-subset(trumpilot, is.finite(votech)) #Do we want to throw out all cases in which a major party candidate ran unopposed by the other major party candidate?

## Generate state variable for state fixed effects
trumpilot$statefips <- as.factor(floor(trumpilot$FIPS/1000))
trumpilot$soyval<-with(trumpilot, 100*sales_USD/(GDP2012*1000))


```

Basic models:
```{r}

## All counties, predicted using soybeans production in bushels:
summary(lm(data = trumpilot, votech ~ prod_bush))
summary(lm(data = trumpilot, votech ~ log(1 + prod_bush))) 
summary(lm(data = trumpilot, votech ~ statefips + prod_bush))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + prod_bush)))

## All counties, predicted using soybeans sales, USD:
summary(lm(data = trumpilot, votech ~ sales_USD))
summary(lm(data = trumpilot, votech ~ log(1 + sales_USD)))
summary(lm(data = trumpilot, votech ~ statefips + sales_USD))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + sales_USD)))

## All counties, predicted using soybeans area, acres:
summary(lm(data = trumpilot, votech ~ soyarea))
summary(lm(data = trumpilot, votech ~ log(1 + soyarea)))
summary(lm(data = trumpilot, votech ~ statefips + soyarea))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + soyarea)))


## All counties, predicted using percent of county GDP from soybeans
summary(lm(data = trumpilot, votech ~ soyval))
summary(lm(data = trumpilot, votech ~ log(1 + soyval)))
summary(lm(data = trumpilot, votech ~ statefips + soyval))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + soyval)))

## Counties not split between House districts, predicted using soybeans production in bushels:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ prod_bush))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + prod_bush)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + prod_bush))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + prod_bush)))

## Counties not split between House districts, predicted using soybeans sales, USD:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + sales_USD)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + sales_USD)))

## Counties not split between House districts, predicted using soybeans area, acres:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + sales_USD)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + sales_USD)))


## Counties not split between House districts, predicted using percent of county GDP from soybeans
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ soyval))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + soyval)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + soyval))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + soyval)))

## Counties not split between House districts, predicted using percent of county area used for soybean planting
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ soyarea))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + soyarea)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + soyarea))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + soyarea)))

```

Models with controls:
```{r}
## All counties:
summary(lm(data = trumpilot, votech ~ prod_bush + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ soyarea + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ soyval + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))


## Counties not split between House districts
summary(lm(data = trumpilot[trumpilot$Splitflag==0,],votech ~ prod_bush+log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))


#With fixed effects:
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + prod_bush+log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

## Counties not split between House districts, predicted using percent of county area used for soybean planting
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ prod_bush+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

#With Fixed Effects:
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + prod_bush+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

```

Centering all variables:
```{r}
library(tidyverse)
library(magrittr)
center<-function(myvar){
  (myvar-mean(myvar, na.rm=TRUE))
}

tr_cr<-trumpilot %>% 
  select(votech,sales_USD,soyval,soyarea,prod_bush, GDP2015, stateGDP, medinc1317,perc_HS_GED, totpop1317,urb2010,perclatino1317,trumpmarg)  %>% 
  mutate(ln_GDP2015=log(GDP2015/1000), ln_stateGDP=log(stateGDP/1000000), ln_inc=log(medinc1317/1000), ln_pop=log(totpop1317/1000), sales_USD=sales_USD/1000000, soyarea=soyarea/100000,prod_bush=prod_bush/1000000, ln_soysales=log(sales_USD/1000000), ln_soyval=log(soyval+1), ln_soyarea=log(soyarea/100000+1), ln_prod_bush=log(prod_bush+1)) 

tr_cr<-do.call(cbind,lapply(tr_cr,center))
newnames<-paste(names(as.data.frame(tr_cr)),"_cr",sep="")
colnames(tr_cr)<-newnames

trumpilot1<-cbind.data.frame(trumpilot,tr_cr)

```


Multi-level models:
```{r}
library(lme4)
#Random intercepts
## All counties, predicted using bushels:
summary(mlm<-lmer(data = trumpilot1, votech_cr ~ prod_bush_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
coef(mlm)
fixef(mlm) #average coefficient effects
ranef(mlm) #Random intercepts

summary(lmer(data = trumpilot1, votech_cr ~ sales_USD_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
summary(lmer(data = trumpilot1, votech_cr ~ soyarea_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
summary(lmer(data = trumpilot1, votech_cr ~ soyval_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))


##Counties not split between House districts, predicted using percent of county GDP from soybeans
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ prod_bush_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ sales_USD_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ soyarea_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ soyval_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 +ln_stateGDP_cr | statefips)))


```

State and district ranefs:
```{r}
trumpilot1<-trumpilot1 %>% mutate(dist_state=as.factor(paste0(state,Dist)))

##Counties not split between House districts, predicted using percent of county GDP from soybeans
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ soyval12_cr + ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+totpop1317_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)+ (1 | dist_state)))
summary(lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ ln_soyval12_cr +ln_GDP2015_cr+ln_inc_cr+perc_HS_GED_cr+totpop1317_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)+ (1 | dist_state)))

## Counties not split between House districts, predicted using percent of county area used for soybean planting
summary(mlm<-lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ soypct_cr + ln_GDP2015_cr+ln_inc_cr+totpop1317_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | dist_state)))
summary(mlm<-lmer(data = trumpilot1[trumpilot$Splitflag==0,], votech_cr ~ ln_soypct_cr + ln_GDP2015_cr+ln_inc_cr+totpop1317_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | dist_state)))

```


