---
title: "dataanalysis"
author: "Olga Chyzh"
date: "February 14, 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message = FALSE,warning = FALSE,fig.cap = "...")
```

Libraries:
```{r}
library(tidyverse)
library(magrittr)
library(lme4)
<<<<<<< HEAD
library(xtable)
=======
>>>>>>> 723efc59d4eb30fc945011f3cd1804b1278b13c4
```

```{r}
rm(list=ls())
trumpilot<-read.csv("soydata.csv", header=TRUE)
## Generate measure of vote shift
trumpilot$votech <- with(trumpilot, log(as.numeric(Rep18)*as.numeric(Dem16)/(as.numeric(Rep16)*as.numeric(Dem18))))
trumpilot<-subset(trumpilot, is.finite(votech)) #Do we want to throw out all cases in which a major party candidate ran unopposed by the other major party candidate?

## Generate state variable for state fixed effects
trumpilot$statefips <- as.factor(floor(trumpilot$FIPS/1000))
trumpilot$soyval<-with(trumpilot, 100*sales_USD/(GDP2012*1000))
trumpilot$soyval[is.na(trumpilot$soyval)]<-0


```

Basic models:
```{r}

## All counties, predicted using soybeans production in bushels:
summary(lm(data = trumpilot, votech ~ prod_bush))
summary(lm(data = trumpilot, votech ~ log(1 + prod_bush))) 
summary(lm(data = trumpilot, votech ~ statefips + prod_bush))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + prod_bush)))

## All counties, predicted using soybeans sales, USD:
summary(lm(data = trumpilot, votech ~ sales_USD))
summary(lm(data = trumpilot, votech ~ log(1 + sales_USD)))
summary(lm(data = trumpilot, votech ~ statefips + sales_USD))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + sales_USD)))

## All counties, predicted using soybeans area, acres:
summary(lm(data = trumpilot, votech ~ soyarea))
summary(lm(data = trumpilot, votech ~ log(1 + soyarea)))
summary(lm(data = trumpilot, votech ~ statefips + soyarea))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + soyarea)))


## All counties, predicted using percent of county GDP from soybeans
summary(lm(data = trumpilot, votech ~ soyval))
summary(lm(data = trumpilot, votech ~ log(1 + soyval)))
summary(lm(data = trumpilot, votech ~ statefips + soyval))
summary(lm(data = trumpilot, votech ~ statefips + log(1 + soyval)))

## Counties not split between House districts, predicted using soybeans production in bushels:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ prod_bush))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + prod_bush)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + prod_bush))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + prod_bush)))

## Counties not split between House districts, predicted using soybeans sales, USD:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + sales_USD)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + sales_USD)))

## Counties not split between House districts, predicted using soybeans area, acres:
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + sales_USD)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + sales_USD))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + sales_USD)))


## Counties not split between House districts, predicted using percent of county GDP from soybeans
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ soyval))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + soyval)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + soyval))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + soyval)))

## Counties not split between House districts, predicted using percent of county area used for soybean planting
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ soyarea))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ log(1 + soyarea)))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + soyarea))
summary(lm(data = subset(trumpilot, is.finite(votech) & Splitflag == 0), votech ~ statefips + log(1 + soyarea)))

```

Models with controls:
```{r}
## All counties:
summary(lm(data = trumpilot, votech ~ prod_bush + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ soyarea + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot, votech ~ soyval + log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))


## Counties not split between House districts
summary(lm(data = trumpilot[trumpilot$Splitflag==0,],votech ~ prod_bush+log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))


#With fixed effects:
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + prod_bush+log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

## Counties not split between House districts, predicted using percent of county area used for soybean planting
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ prod_bush+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

#With Fixed Effects:
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + prod_bush+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + sales_USD+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyarea+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))
summary(lm(data = trumpilot[trumpilot$Splitflag==0,], votech ~ statefips + soyval+ log(GDP2015)+log(medinc1317)+perc_HS_GED+log(totpop1317)+urb2010+perclatino1317+trumpmarg))

```

Centering all variables:
```{r}

center<-function(myvar){
  (myvar-mean(myvar, na.rm=TRUE))
}

tr_cr<-trumpilot %>% 
  select(sales_USD,soyval,soyarea,prod_bush, GDP2015, stateGDP, medinc1317,perc_HS_GED, perc_BA, totpop1317,urb2010,perclatino1317,trumpmarg)  %>% 
  mutate(ln_GDP2015=log(GDP2015/1000), ln_stateGDP=log(stateGDP/1000000), ln_inc=log(medinc1317/1000), ln_pop=log(totpop1317/1000), perclatino1317=perclatino1317*100,perc_HS_GED=perc_HS_GED*100,perc_BA=perc_BA*100,sales_USD=sales_USD/100000, soyarea=soyarea/640,prod_bush=prod_bush/1000000, ln_sales_USD=log(sales_USD/100000+1), ln_soyval=log(soyval+1), ln_soyarea=log(soyarea/640+1), ln_prod_bush=log(prod_bush+1)) 

tr_cr<-do.call(cbind,lapply(tr_cr,center))
newnames<-paste(names(as.data.frame(tr_cr)),"_cr",sep="")
colnames(tr_cr)<-newnames


trumpilot1<-cbind.data.frame(subset(trumpilot, select=c("statefips","state","county","Dist","Splitflag","votech")),tr_cr)

```


Multi-level models:
```{r}

## All counties, predicted using bushels:
summary(m1_full<-lmer(data = trumpilot1, votech ~ ln_prod_bush_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1  | statefips)))
summary(m2_full<-lmer(data = trumpilot1, votech ~ ln_soyval_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1  | statefips)))

summary(lmer(data = trumpilot1, votech ~ ln_prod_bush_cr + ln_GDP2015_cr+perc_HS_GED_cr+perc_BA_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1  | statefips)))


summary(lmer(data = trumpilot1, votech ~ ln_sales_USD_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1  | statefips)))
summary(lmer(data = trumpilot1, votech ~ ln_soyarea_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1  | statefips)))


```

Centering variables in non-split county subset:
```{r}

center<-function(myvar){
  (myvar-mean(myvar, na.rm=TRUE))
}

tr_cr<-trumpilot %>% 
  filter(Splitflag==0) %>%
  select(sales_USD,soyval,soyarea,prod_bush, GDP2015, stateGDP, medinc1317,perc_HS_GED, totpop1317,urb2010,perclatino1317,trumpmarg)  %>% 
  mutate(ln_GDP2015=log(GDP2015/1000), ln_stateGDP=log(stateGDP/1000000), ln_inc=log(medinc1317/1000), ln_pop=log(totpop1317/1000),perclatino1317=perclatino1317*100,perc_HS_GED=perc_HS_GED*100,  sales_USD=sales_USD/100000, soyarea=soyarea/640,prod_bush=prod_bush/1000000, ln_sales_USD=log(sales_USD/100000+1), ln_soyval=log(soyval+1), ln_soyarea=log(soyarea/640+1), ln_prod_bush=log(prod_bush+1)) 

tr_cr<-do.call(cbind,lapply(tr_cr,center))
newnames<-paste(names(as.data.frame(tr_cr)),"_cr",sep="")
colnames(tr_cr)<-newnames


trumpilot2<-cbind.data.frame(subset(trumpilot[trumpilot$Splitflag==0,], select=c("statefips","state","county","Dist","votech")),tr_cr)

```



```{r}
##Counties not split between House districts, predicted using percent of county GDP from soybeans
summary(m1<-lmer(data = trumpilot2, votech ~ ln_prod_bush_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)))
summary(m2<-lmer(data = trumpilot2, votech ~ soyval_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)))

summary(lmer(data = trumpilot2, votech ~ ln_sales_USD_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)))
summary(lmer(data = trumpilot2, votech ~ ln_soyarea_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)))


```



State and district ranefs:
```{r}
trumpilot2<-trumpilot2 %>% mutate(dist_state=as.factor(paste0(state,Dist)))

##Counties not split between House districts
summary(lmer(data = trumpilot2, votech ~ ln_prod_bush_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)+ (1 | dist_state)))
summary(lmer(data = trumpilot2, votech ~ ln_soyval_cr +ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)+ (1 | dist_state)))

summary(lmer(data = trumpilot2, votech ~ ln_sales_USD_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr +   (1 | statefips)+(1 | dist_state)))
summary(lmer(data = trumpilot2, votech ~ ln_soyarea_cr + ln_GDP2015_cr+perc_HS_GED_cr+ln_pop_cr+urb2010_cr+perclatino1317_cr+trumpmarg_cr + (1 | statefips)+(1 | dist_state)))


```
Plot Effects:
```{r}
coef(m1) #coef calculates state-specific intercepts as re+fe
fixef(m1) #main (average) effects
ranef(m1) #Random (state-level) intercepts
theme_set(theme_grey() + theme(panel.background = element_rect(fill = NA, color = 'black'))+ theme(axis.text=element_text(size=10),
					axis.title=element_text(size=12,face="bold")))



ln_prod_bush=seq(min(log(trumpilot$prod_bush+1), na.rm=TRUE),max(log(trumpilot$prod_bush+1), na.rm=TRUE), by=.1)
mycoef<-as.matrix(fixef(m1)[1:2])

mycov<-vcov(m1)
yhat<-cbind(1,ln_prod_bush)%*%mycoef
se_yhat<-sqrt(mycov[1,1]+(ln_prod_bush^2)*mycov[2,2]+2*ln_prod_bush*mycov[1,2])

mylabel<-1-yhat

p<-ggplot()+geom_line(aes(x=(exp(ln_prod_bush))/1000,y=exp(yhat)))+geom_ribbon(aes(x=(exp(ln_prod_bush))/1000, ymin=exp(yhat-2*se_yhat),ymax=exp(yhat+2*se_yhat)), alpha=.1) 
p + scale_y_continuous("Expected Change in Republican Vote Share, %", limits=c(0,1), breaks=seq(.1,1,.1), labels=seq(-100,-10,10))+scale_x_log10("Soy Production, Thousands of Bushels", breaks=c(0.01,1,100,10000), labels=c("0.01","1","100","10000"))
ggsave("fitted.pdf")


```
